export LD_LIBRARY_PATH
PETSC_DIR = /home/tbent/applications/petsc-3.5.2 
PETSC_ARCH = arch-linux2-c-debug

INCLUDE += -I./src
INCLUDE += -I./lib/unittest-cpp/src
INCLUDE += -I./lib/actor-framework/libcaf_core
INCLUDE += -I./lib/actor-framework/libcaf_opencl
INCLUDE += -I./lib/autocheck/include
INCLUDE += -I$(PETSC_DIR)/$(PETSC_ARCH)/include
INCLUDE += -I$(PETSC_DIR)/include
INCLUDE += -I./lib/eigen-dev

CPPFLAGS += -Wall
CPPFLAGS += -std=c++11
CPPFLAGS += -Winvalid-pch
CPPFLAGS += -pipe
CPPFLAGS += $(INCLUDE)
CPPFLAGS += -fopenmp
CPPFLAGS += -mavx

EXAMPLECPPFLAGS += $(CPPFLAGS)

DEBUGFLAGS += -g 
DEBUGFLAGS += -Og
DEBUGFLAGS += -DDEBUG=1

RELEASEFLAGS += -DNDEBUG=1 
RELEASEFLAGS += -O3
RELEASEFLAGS += -funroll-loops

PROFILEFLAGS += $(RELEASEFLAGS)
PROFILEFLAGS += -g

// CPPFLAGS += $(DEBUGFLAGS)
CPPFLAGS += $(RELEASEFLAGS)
// CPPFLAGS += $(PROFILEFLAGS)

SHAREDLIBFLAGS += $(CPPFLAGS) 
SHAREDLIBFLAGS += -fPIC

LINKFLAGS += -fopenmp
LINKFLAGS += -lglut -lGL -lGLU -lGLEW
LINKFLAGS += -lOpenCL
LINKFLAGS += -Wl,-rpath=./lib/actor-framework/build/lib
LINKFLAGS += -L./lib/actor-framework/build/lib
LINKFLAGS += -lcaf_core -lcaf_opencl
LINKFLAGS += -Wl,-rpath=$(PETSC_DIR)/$(PETSC_ARCH)/lib
LINKFLAGS += -L$(PETSC_DIR)/$(PETSC_ARCH)/lib
LINKFLAGS += -lpetsc
LIBLINKFLAGS += -shared
LIBLINKFLAGS += $(LINKFLAGS)

LIBNAME = fmm.so

TESTLINKFLAGS += -L./lib/unittest-cpp
TESTLINKFLAGS += -Wl,-rpath=.
TESTLINKFLAGS += -l:$(LIBNAME)
TESTLINKFLAGS += -lUnitTest++
TESTLINKFLAGS += $(LINKFLAGS)

EXAMPLELINKFLAGS += -Wl,-rpath=.
EXAMPLELINKFLAGS += -l:$(LIBNAME)
EXAMPLELINKFLAGS += $(LINKFLAGS)

INTTESTLINKFLAGS += $(EXAMPLELINKFLAGS)

// COMPILER = g++
COMPILER = mpic++

: foreach src/*.cpp |> $(COMPILER) $(SHAREDLIBFLAGS) -c %f -o %o |> src/%B.o
: src/*.o |> $(COMPILER) %f -o %o $(LIBLINKFLAGS) |> $(LIBNAME)
: foreach test/*.cpp |> $(COMPILER) $(CPPFLAGS) -c %f -o %o |> test/%B.o
: foreach test/*.cpp |> $(COMPILER) $(CPPFLAGS) -S %f -o %o |> test/%B.s
: foreach test/*.o | $(LIBNAME) |> $(COMPILER) %f -o %o $(TESTLINKFLAGS) |> test/%B
: foreach examples/*.cpp |> $(COMPILER) $(CPPFLAGS) -c %f -o %o |> examples/%B.o
: foreach examples/*.o | $(LIBNAME) |> $(COMPILER) %f -o %o $(EXAMPLELINKFLAGS) |> examples/%B
: foreach inttest/*.cpp |> $(COMPILER) $(CPPFLAGS) -c %f -o %o |> inttest/%B.o
: foreach inttest/*.o | $(LIBNAME) |> $(COMPILER) %f -o %o $(INTTESTLINKFLAGS) |> inttest/%B
