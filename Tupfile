INCLUDE += -I./src
INCLUDE += -I./lib/UnitTest++/src

CPPFLAGS += -Wall
CPPFLAGS += -std=c++11
CPPFLAGS += -Winvalid-pch
CPPFLAGS += -pipe
CPPFLAGS += $(INCLUDE)
CPPFLAGS += -fopenmp
CPPFLAGS += -mavx

DEBUGFLAGS += -g 
DEBUGFLAGS += -Og
DEBUGFLAGS += -DDEBUG=1

RELEASEFLAGS += -DNDEBUG=1 
RELEASEFLAGS += -Ofast

PROFILEFLAGS += $(RELEASEFLAGS)
PROFILEFLAGS += -g

# Currently a debug build.
// CPPFLAGS += $(DEBUGFLAGS)
// CPPFLAGS += $(RELEASEFLAGS)
CPPFLAGS += $(PROFILEFLAGS)

SHAREDLIBFLAGS += $(CPPFLAGS) 
SHAREDLIBFLAGS += -fPIC

LINKFLAGS += -lm
LINKFLAGS += -fopenmp
LIBLINKFLAGS += -shared
LIBLINKFLAGS += $(LINKFLAGS)

LIBNAME = fmm.so

TESTLINKFLAGS += -L./lib/UnitTest++
TESTLINKFLAGS += -Wl,-rpath=.
TESTLINKFLAGS += -l:$(LIBNAME)
TESTLINKFLAGS += -lUnitTest++
TESTLINKFLAGS += $(LINKFLAGS)

EXAMPLELINKFLAGS += -Wl,-rpath=.
EXAMPLELINKFLAGS += -l:$(LIBNAME)
EXAMPLELINKFLAGS += $(LINKFLAGS)

// COMPILER = g++
COMPILER = mpic++

: foreach src/*.cpp |> $(COMPILER) $(SHAREDLIBFLAGS) -c %f -o %o |> src/%B.o
: src/*.o |> $(COMPILER) %f -o %o $(LIBLINKFLAGS) |> $(LIBNAME)
: foreach test/*.cpp |> $(COMPILER) $(CPPFLAGS) -c %f -o %o |> test/%B.o
: test/*.o | $(LIBNAME) |> $(COMPILER) %f -o %o $(TESTLINKFLAGS) |> test/run_tests
: foreach examples/*.cpp |> $(COMPILER) $(CPPFLAGS) -c %f -o %o |> examples/%B.o
: foreach examples/*.o | $(LIBNAME) |> $(COMPILER) %f -o %o $(EXAMPLELINKFLAGS) |> examples/%B
